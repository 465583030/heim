# The etcd container coordinates our single-node cluster.
etcd:
  build: containers/etcd

# The psql container runs the postgres server from the psqldata/data directory.
psql:
  build: containers/psql
  volumes:
    - _psqldata/data:/var/lib/postgresql/data

# The psqlclient container provides a client connection to the psql container.
# TODO: add volume for persistent readline history, sql dumps, etc.
psqlclient:
  command: psql -h psql -p 5432 -U postgres heim
  build: containers/psql/client
  links:
    - psql

# The frontend container runs an ongoing gulp build.
frontend:
  command: gulp build
  build: client
  volumes:
    - client:/srv/heim/client/src
    - deps/node_modules:/srv/heim/client/src/node_modules
    - client/build:/srv/heim/client/src/build
  environment:
    NODE_ENV: development

# The upgradedb container runs the upgradedb command against the psql container.
upgradedb:
  build: upgradedb
  links:
    - psql
  volumes:
    - backend/psql/migrations:/migrations

# The backend container runs the backend server against the psql container.
backend:
  build: backend
  links:
    - etcd
    - psql
  volumes:
    - .:/go/src/heim
    - deps/godeps:/godeps
    - client/build:/srv/heim/client/src/build
    - backend/console/keys:/keys
  ports:
    - "8080:80"
    - "2222:2222"

# This secondary backend container is available to test multinode clusters.
backend2:
  build: backend
  links:
    - etcd
    - psql
  volumes:
    - .:/go/src/heim
    - deps/godeps:/godeps
    - client/build:/srv/heim/client/src/build
    - backend/console/keys:/keys
  ports:
    - "8081:80"
